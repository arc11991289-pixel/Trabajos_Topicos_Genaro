package practica9;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.JOptionPane;
import javax.swing.SwingUtilities; // Importar SwingUtilities

/**
 * Muestra la hora y fecha actualizándose en un JTextField utilizando un hilo.
 */
public class RelojDigital extends javax.swing.JFrame implements Runnable {
    
    private static final Logger REGISTRO = Logger.getLogger(RelojDigital.class.getName());

    // Objeto Thread que ejecutará la tarea de actualización
    private Thread hiloReloj;
    
    // Formato para mostrar la fecha y hora
    private final DateTimeFormatter FORMATO = DateTimeFormatter.ofPattern("HH:mm:ss dd-MM-yyyy");

    /**
     * Creates new form RelojDigital
     */
    public RelojDigital() {
        initComponents();
        this.setLocationRelativeTo(null);
        tfFechaHora.setEditable(false);
        tfFechaHora.setText("Presiona 'Iniciar'");
        btnDetener.setEnabled(false);
    }
    
    /**
     * Tarea del hilo: actualizar la hora continuamente.
     */
    @Override
    public void run() {
        // Bucle infinito que se detendrá solo si el hilo es interrumpido
        while (!Thread.currentThread().isInterrupted()) {
            try {
                // 1. Obtener la hora actual y darle formato
                String horaActual = LocalDateTime.now().format(FORMATO);
                
                // 2. Actualizar la GUI
                // SwingUtilities.invokeLater asegura que la actualización del componente se haga en el EDT (Event Dispatch Thread)
                SwingUtilities.invokeLater(() -> {
                    tfFechaHora.setText(horaActual);
                });
                
                // 3. Dormir el hilo por 1 segundo (1000 milisegundos)
                Thread.sleep(1000); 

            } catch (InterruptedException ex) {
                // Si Thread.sleep es interrumpido, lanza esta excepción.
                // Es la señal de que debemos salir del bucle.
                REGISTRO.log(Level.INFO, "Hilo de reloj interrumpido: Deteniendo la ejecución.");
                Thread.currentThread().interrupt(); // Restaura el estado de interrupción
            } catch (Exception ex) {
                REGISTRO.log(Level.SEVERE, "Error durante la ejecución del hilo del reloj.", ex);
            }
        }
    }


    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        tfFechaHora = new javax.swing.JTextField();
        btnIniciar = new javax.swing.JButton();
        btnDetener = new javax.swing.JButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);
        setTitle("Reloj Digital Concurrente");

        tfFechaHora.setHorizontalAlignment(javax.swing.JTextField.CENTER);

        btnIniciar.setText("Iniciar");
        btnIniciar.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnIniciarActionPerformed(evt);
            }
        });

        btnDetener.setText("Detener");
        btnDetener.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnDetenerActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGap(46, 46, 46)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(btnIniciar)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addComponent(btnDetener))
                    .addComponent(tfFechaHora, javax.swing.GroupLayout.PREFERRED_SIZE, 216, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addContainerGap(47, Short.MAX_VALUE))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGap(36, 36, 36)
                .addComponent(tfFechaHora, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 39, Short.MAX_VALUE)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(btnIniciar)
                    .addComponent(btnDetener))
                .addGap(32, 32, 32))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void btnIniciarActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnIniciarActionPerformed
        // 1. Crear el nuevo hilo (si no existe o ya terminó)
        if (hiloReloj == null || !hiloReloj.isAlive()) {
            hiloReloj = new Thread(this); // 'this' es la instancia de RelojDigital (Runnable)
            hiloReloj.start();
            btnIniciar.setEnabled(false);
            btnDetener.setEnabled(true);
            REGISTRO.log(Level.INFO, "Reloj iniciado.");
        }
    }//GEN-LAST:event_btnIniciarActionPerformed

    private void btnDetenerActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnDetenerActionPerformed
        // 1. Detener el hilo de forma segura
        if (hiloReloj != null && hiloReloj.isAlive()) {
            hiloReloj.interrupt(); // Establece la bandera de interrupción
            btnIniciar.setEnabled(true);
            btnDetener.setEnabled(false);
            tfFechaHora.setText("Detenido.");
            REGISTRO.log(Level.INFO, "Reloj detenido.");
        }
    }//GEN-LAST:event_btnDetenerActionPerformed

    /**
     * @param args the command line arguments
     */
    public static void main(String args[]) {
        /* Set the System look and feel */
        try {
            javax.swing.UIManager.setLookAndFeel(javax.swing.UIManager.getSystemLookAndFeelClassName());
        } catch (ReflectiveOperationException | javax.swing.UnsupportedLookAndFeelException ex) {
            REGISTRO.log(Level.SEVERE, "Error al configurar el Look and Feel", ex);
        }

        /* Create and display the form */
        java.awt.EventQueue.invokeLater(() -> new RelojDigital().setVisible(true));
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnDetener;
    private javax.swing.JButton btnIniciar;
    private javax.swing.JTextField tfFechaHora;
    // End of variables declaration//GEN-END:variables
}